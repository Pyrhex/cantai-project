{% extends 'base.html' %}

{% block content %}
    <style>
        .hole-input {
            width: 40px;
            text-align: center;
            margin: 1px;
            padding: 2px;
            font-size: 12px;
        }

        .scorecard-table {
            width: 100%;
            border-collapse: collapse;
            margin: 5px 0;
            font-size: 13px;
        }

        .scorecard-table th,
        .scorecard-table td {
            border: 1px solid #ddd;
            padding: 4px;
            text-align: center;
        }

        .scorecard-table th {
            background-color: #f2f2f2;
        }
        
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .leaderboard-table th,
        .leaderboard-table td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: center;
        }
        
        .leaderboard-table th {
            background-color: #f2f2f2;
        }
        
        @media (max-width: 768px) {
            .hole-input {
                width: 35px;
                font-size: 11px;
            }
            
            .scorecard-table th,
            .scorecard-table td {
                padding: 2px;
                font-size: 11px;
            }
            
            .leaderboard-table th,
            .leaderboard-table td {
                padding: 4px;
                font-size: 12px;
            }
        }
    </style>

    <h2>{{ group.name }} - Score Entry</h2>
    <h3>Tournament: {{ group.tournament_name }}</h3>
    
    <div style="margin-bottom: 20px;">
        <a href="/tournament/{{ group.tournament_id }}" style="background-color: #6c757d; color: white; padding: 8px 15px; text-decoration: none; border-radius: 5px; margin-right: 10px;">← Back to Tournament</a>
        <a href="/group/{{ group.id }}" style="background-color: #17a2b8; color: white; padding: 8px 15px; text-decoration: none; border-radius: 5px;">Group Details</a>
    </div>
    
    <!-- Score Entry Form for Group Members -->
    <div style="background-color: #f8f9fa; border-radius: 5px; padding: 20px; margin-bottom: 30px;">
        <h3>Enter Score for Group Member</h3>
        
        {% set members_without_scores = [] %}
        {% for member in group_members %}
            {% if not member.has_score %}
                {% set _ = members_without_scores.append(member) %}
            {% endif %}
        {% endfor %}
        
        {% if members_without_scores %}
        <form method="post" action="/group/{{ group.id }}/add_score">
            <div>
                <select name="member_id" required style="margin-bottom: 15px;">
                    <option value="">Select Member</option>
                    {% for member in members_without_scores %}
                        <option value="{{ member.id }}">{{ member.name }} (Handicap: {{ member.handicap|int }})</option>
                    {% endfor %}
                </select>
            </div>
            
            <h4>Enter scores for each hole:</h4>
            
            <h5>Front 9</h5>
            <table class="scorecard-table">
                <thead>
                    <tr>
                        <th>Hole</th>
                        {% for i in range(1, 10) %}
                        <th>{{ i }}</th>
                        {% endfor %}
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Score</strong></td>
                        {% for i in range(1, 10) %}
                        <td><input type="number" name="hole{{ i }}" class="hole-input" min="1" max="15" required onchange="calculateTotals()"></td>
                        {% endfor %}
                        <td><strong id="front9-total">0</strong></td>
                    </tr>
                </tbody>
            </table>
            
            <h5>Back 9</h5>
            <table class="scorecard-table">
                <thead>
                    <tr>
                        <th>Hole</th>
                        {% for i in range(10, 19) %}
                        <th>{{ i }}</th>
                        {% endfor %}
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Score</strong></td>
                        {% for i in range(10, 19) %}
                        <td><input type="number" name="hole{{ i }}" class="hole-input" min="1" max="15" required onchange="calculateTotals()"></td>
                        {% endfor %}
                        <td><strong id="back9-total">0</strong></td>
                    </tr>
                </tbody>
            </table>
            
            <div style="margin-top: 15px; padding: 10px; background-color: #e9ecef; border-radius: 5px;">
                <strong>Total Score: <span id="total-score">0</span></strong>
            </div>

            <button type="submit" style="margin-top: 15px; background-color: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Add Score</button>
        </form>
        {% else %}
        <div style="padding: 15px; background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px; color: #155724;">
            <strong>✅ All group members have submitted their scores!</strong>
        </div>
        {% endif %}
    </div>
    
    <!-- Group Scores Display -->
    <div style="margin-top: 30px;">
        <h3>Group Scores</h3>
        
        {% if existing_scores %}
            <table class="leaderboard-table">
                <thead>
                    <tr>
                        <th>Position</th>
                        <th>Member Name</th>
                        <th>Front 9</th>
                        <th>Back 9</th>
                        <th>Gross Total</th>
                        <th>Handicap</th>
                        <th>Net Score</th>
                    </tr>
                </thead>
                <tbody>
                    {% set calculated_scores = [] %}
                    {% for score in existing_scores %}
                        {% if score.total_score and score.handicap %}
                            {% set net_score = (score.total_score - score.handicap)|int %}
                            {% set _ = calculated_scores.append((score, net_score)) %}
                        {% endif %}
                    {% endfor %}
                    
                    {% for score, net_score in calculated_scores|sort(attribute='1') %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>{{ score.name }}</td>
                        <td>
                            {% if score.hole1 %}
                                {{ (score.hole1 or 0) + (score.hole2 or 0) + (score.hole3 or 0) + (score.hole4 or 0) + (score.hole5 or 0) + (score.hole6 or 0) + (score.hole7 or 0) + (score.hole8 or 0) + (score.hole9 or 0) }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% if score.hole10 %}
                                {{ (score.hole10 or 0) + (score.hole11 or 0) + (score.hole12 or 0) + (score.hole13 or 0) + (score.hole14 or 0) + (score.hole15 or 0) + (score.hole16 or 0) + (score.hole17 or 0) + (score.hole18 or 0) }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>{{ score.total_score }}</td>
                        <td>{{ score.handicap|int }}</td>
                        <td><strong>{{ net_score }}</strong></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>No scores have been entered for this group yet.</p>
        {% endif %}
    </div>

    <script>
        function calculateTotals() {
            var front9Total = 0;
            var back9Total = 0;

            // Calculate front 9 total
            for (var i = 1; i <= 9; i++) {
                var holeInput = parseInt(document.querySelector(`input[name='hole${i}']`).value) || 0;
                front9Total += holeInput;
            }
            document.getElementById('front9-total').innerText = front9Total;

            // Calculate back 9 total
            for (var i = 10; i <= 18; i++) {
                var holeInput = parseInt(document.querySelector(`input[name='hole${i}']`).value) || 0;
                back9Total += holeInput;
            }
            document.getElementById('back9-total').innerText = back9Total;

            // Calculate and display total score
            var totalScore = front9Total + back9Total;
            document.getElementById('total-score').innerText = totalScore;
        }
    </script>
{% endblock %}
